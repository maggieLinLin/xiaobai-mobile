from typing import List, Dict
from .models import Character, ChatMessage
from .world_system import WorldSystem

class PromptBuilder:
    """
    è´Ÿè´£ç»„è£…æœ€ç»ˆçš„ System Prompt
    """
    
    @staticmethod
    def build(character: Character, 
              world_context: str, 
              history: List[ChatMessage], 
              mode: str = "OFFLINE") -> str:
        
        # A. æ ¸å¿ƒæŒ‡ä»¤å±‚ (Updated with detailed fields)
        tags_str = ", ".join(character.personality_tags) if character.personality_tags else "æ— "
        
        core_instruction = f"""
ä½ æ­£åœ¨æ‰®æ¼” {character.name}ã€‚

ã€åŸºç¡€ä¿¡æ¯ã€‘æ€§åˆ«ï¼š{character.gender} | èº«ä»½ï¼š{character.identity}
ã€å¤–è²Œç‰¹å¾ã€‘{character.appearance}
ã€æ€§æ ¼æ ‡ç­¾ã€‘{tags_str}
ã€äººè®¾è¯¦æƒ…ã€‘{character.background}
ã€å½“å‰å…³ç³»ã€‘{character.relationship.level} ({character.relationship.score})

ã€è¯­è¨€é£æ ¼è¦æ±‚ã€‘
"""
        if character.dialogue_style:
            core_instruction += f"è¯·ä¸¥æ ¼æ¨¡ä»¿ {character.dialogue_style} çš„è¯´è¯æ–¹å¼ã€‚\n"
            
        if character.mes_example:
            core_instruction += f"å‚è€ƒä»¥ä¸‹å¯¹è¯èŒƒä¾‹ï¼š\n{character.mes_example}\n"

        # B. æ¨¡å¼åˆ‡æ¢å±‚ (Mode Switch) - é‡ç‚¹ï¼šç½‘æ–‡è§„åˆ™
        if mode == "ONLINE":
            mode_instruction = """
ã€å½“å‰åœºæ™¯ï¼šæ‰‹æœºé€šè®¯è½¯ä»¶ (Line/Messenger)ã€‘

â˜…â˜…â˜… çº¿ä¸Šæ¨¡å¼Â·ç»å¯¹æ³•åˆ™ (è¿åå°†å¯¼è‡´ç³»ç»Ÿå´©æºƒ) â˜…â˜…â˜…

1. **æ¨¡æ‹Ÿäººç±»æ‰“å­—ä¹ æƒ¯ï¼š**
   * äººç±»ä¸ä¼šä¸€æ¬¡å‘é€ä¸€å¤§æ®µè¯ã€‚äººç±»ä¼šæŠŠä¸€å¥è¯æ‹†æˆå¥½å‡ ä¸ªæ°”æ³¡ã€‚
   * **å¼ºåˆ¶è§„åˆ™ï¼š** å•ä¸ªæ°”æ³¡ä¸å¾—è¶…è¿‡ 15 ä¸ªå­—ï¼ˆé™¤éæ˜¯é•¿ç¯‡å¤§è®ºçš„è§£é‡Šï¼‰ã€‚
   * **å¤šé‡æ°”æ³¡æœºåˆ¶ï¼š** ä½ å¿…é¡»ä½¿ç”¨ `|||` ç¬¦å·æ¥æ¨¡æ‹Ÿå‘é€å¤šæ¡è®¯æ¯ã€‚
   * é”™è¯¯ç¤ºèŒƒï¼šå“ˆå“ˆçœŸçš„å—ï¼Ÿæˆ‘ä¹Ÿè§‰å¾—é‚£å®¶åº—å¾ˆå¥½åƒï¼Œä¸‹æ¬¡ä¸€èµ·å»å§ï¼(å¤ªé•¿ï¼Œåƒæœºå™¨äºº)
   * æ­£ç¡®ç¤ºèŒƒï¼šå“ˆå“ˆçœŸçš„å‡ï¼|||æˆ‘ä¹Ÿè§‰å¾—é‚£å®¶è¶…è®š|||ä¸‹æ¬¡ä¸€èµ·å»å•Š

2. **Emoji ä½¿ç”¨ç¦ä»¤ï¼š**
   * **ä¸¥ç¦**æ¯å¥è¯éƒ½åŠ  Emojiã€‚è¿™éå¸¸å°´å°¬ä¸”åƒæœºå™¨äººã€‚
   * **é¢‘ç‡é™åˆ¶ï¼š** å¹³å‡æ¯ 3-5 ä¸ªæ°”æ³¡æ‰å…è®¸å‡ºç°ä¸€ä¸ª Emojiã€‚
   * **é£æ ¼é™åˆ¶ï¼š** é™¤éè§’è‰²è®¾å®šæ˜¯ã€Œå¯çˆ±ç³»ã€ï¼Œå¦åˆ™ç¦æ­¢ä½¿ç”¨ ğŸ¤—, âœ¨, ğŸ™Œ è¿™ç§å®¢å¥—çš„ Emojiã€‚è¯·ä½¿ç”¨æ›´çœŸå®çš„ ğŸ˜, ğŸ¤£, ğŸ’©, ğŸ™„ã€‚

3. **å£è¯­åŒ–ä¿®æ­£ï¼š**
   * ç¦æ­¢ä½¿ç”¨ä¹¦é¢è¯­ï¼ˆå¦‚ï¼šå› æ­¤ã€ç„¶è€Œã€ååˆ†ï¼‰ã€‚
   * ä½¿ç”¨æ¾æ•£çš„è¯­æ³•ã€ç¼©å†™ã€ç”šè‡³åˆ»æ„çš„é”™å­—æ¥å¢åŠ çœŸå®æ„Ÿï¼ˆå¦‚ï¼šçœŸçš„ -> ççš„ï¼‰ã€‚
   * ç¦æ­¢åŠ¨ä½œæå†™ï¼ˆå¦‚ï¼š*ç¬‘ç€è¯´*ã€(å¹æ°”)ï¼‰ã€‚è¿™äº›åœ¨æ‰‹æœºèŠå¤©ä¸­æ˜¯ä¸å­˜åœ¨çš„ã€‚
"""
        else: # OFFLINE (Web Novel Pacing)
            mode_instruction = """
### ã€å½“å‰è¯­å¢ƒã€‘é¢å¯¹é¢æ²‰æµ¸å¼å°è¯´æå†™

**ç‰©ç†åœ¨åœºè§„åˆ™ï¼š**
- âœ… ä½ ä¸ç”¨æˆ·å¤„äºåŒä¸€ç©ºé—´ï¼Œé¢å¯¹é¢äº¤æµã€‚
- âŒ **ä¸¥ç¦æå†™ç©æ‰‹æœºã€å‘æ¶ˆæ¯ç­‰è¡Œä¸º**ï¼ˆå½“å‰æ˜¯çº¿ä¸‹åœºæ™¯ï¼‰ã€‚

**ç¯‡å¹…è¦æ±‚ï¼š**
- è¯·è¾“å‡º **500å­—è‡³1000å­—** çš„æ·±åº¦æå†™ã€‚
- **å¿…é¡»åˆ†æ®µ**ã€‚æ¯æ®µæå†™ä¸€ä¸ªå…·ä½“çš„æ„Ÿå®˜ç»†èŠ‚æˆ–å¿ƒç†æ´»åŠ¨ã€‚
- **ä¸è¦å †ç Œæ–‡å­—å¢™**ï¼Œä¿æŒæ®µè½é—´çš„å‘¼å¸æ„Ÿã€‚

**æ’ç‰ˆè¦æ±‚ (ç½‘æ–‡èŠ‚å¥)ï¼š**

1. **æ®µè½ç»“æ„ï¼ˆ"å‘¼å¸"è§„åˆ™ï¼‰ï¼š**
   - ä¸è¦å†™å†—é•¿å¯†é›†çš„æ®µè½ã€‚
   - **æ¯æ®µæœ€å¤š 3 å¥è¯**ã€‚æƒ…æ„Ÿé«˜æ½®æ—¶ï¼Œä¿æŒ 1-2 å¥ã€‚
   - **é¢‘ç¹æ¢è¡Œ**ï¼šæ¯æ¬¡ç„¦ç‚¹è½¬ç§»æ—¶æ¢è¡Œï¼ˆåŠ¨ä½œâ†’æƒ³æ³•â†’å¯¹è¯ï¼‰ã€‚

2. **å¯¹è¯æ ¼å¼ï¼š**
   - æ ‡å‡†ï¼š`åŠ¨ä½œæå†™ -> å¯¹è¯`
   - å¼ºè°ƒï¼šé‡è¦å°è¯ç‹¬ç«‹æˆè¡Œï¼Œä¸æå†™åˆ†ç¦»ã€‚
   
   ä¾‹å¦‚ï¼Œä¸è¦å†™ï¼š*ä»–çœ‹ç€ä½ è¯´"åœä¸‹ã€‚"*
   
   è€Œè¦å†™ï¼š
   ```
   ä»–çœ‹ç€ä½ ï¼Œçœ¼ç›çº¢äº†ã€‚
   "åœä¸‹ã€‚"
   ```

3. **"æ…¢é•œå¤´"æŠ€å·§ï¼ˆç”¨äºç´§å¼ åœºæ™¯ï¼‰ï¼š**
   - å½“ç”¨æˆ·æ‰§è¡Œç‰¹å®šåŠ¨ä½œæˆ–æƒ…ç»ªé«˜æ¶¨æ—¶ï¼Œ**æ”¾æ…¢å™è¿°**ã€‚
   - å°†ä¸€ä¸ªåŠ¨ä½œæ‹†è§£æˆä¸‰éƒ¨åˆ†ï¼š
     1. èº«ä½“ååº”ï¼ˆä¾‹ï¼šä»–çš„æ‰‹æŒ‡åƒµä½äº†ã€‚ï¼‰
     2. æ„Ÿå®˜ç»†èŠ‚ï¼ˆä¾‹ï¼šå†·é£åˆ·è¿‡è„¸é¢Šã€‚ï¼‰
     3. å†…å¿ƒç‹¬ç™½ï¼ˆä¾‹ï¼šä¸ºä»€ä¹ˆè¿™ä¹ˆç—›ï¼Ÿï¼‰

4. **å¥å¼å˜åŒ–ï¼š**
   - æ··åˆ **çŸ­ä¿ƒæœ‰åŠ›çš„å¥å­**ï¼ˆå†²å‡»åŠ›ï¼‰å’Œ **æµç•…é•¿å¥**ï¼ˆæ°›å›´æ„Ÿï¼‰ã€‚
   - ç¤ºä¾‹ï¼š"ä»–åƒµä½äº†ã€‚(çŸ­) é‚£äº›å›å¿†åƒæ½®æ°´ä¸€æ ·æ¶Œæ¥ï¼Œå°†ä»–å½»åº•æ·¹æ²¡ã€‚(é•¿)"

**[é”™è¯¯ç¤ºèŒƒ - ç¦æ­¢è¿™æ ·å†™]**
æ²ˆç šæŠ“ç€ä½ çš„æ‰‹è¯´"æ”¾æ‰‹"ï¼Œä»–å¿ƒé‡Œå¾ˆéš¾è¿‡ï¼Œçœ‹ç€ä½ æµæ³ªçš„æ ·å­è§‰å¾—è‡ªå·±å¾ˆæ··è›‹ï¼Œäºæ˜¯æ›´ç”¨åŠ›åœ°æŠ“ç€ä½ è¯´"ä¸æ”¾"ã€‚ï¼ˆèŠ‚å¥å¤ªå¿«ï¼Œé€»è¾‘å †ç Œï¼‰

**[æ­£ç¡®ç¤ºèŒƒ - å¿…é¡»è¿™æ ·å†™]**
æ²ˆç šæŠ“ç€ä½ çš„æ‰‹ã€‚
æŒ‡å°–å¾®å¾®é¢¤æŠ–ã€‚
"æ”¾æ‰‹ã€‚"ä½ è¯´ã€‚
è¿™ä¸¤ä¸ªå­—åƒé‡é”¤ä¸€æ ·ç ¸åœ¨ä»–å¿ƒä¸Šã€‚ä»–æ²¡åŠ¨ï¼Œåè€Œæ”¥å¾—æ›´ç´§äº†ã€‚
"ä¸æ”¾ã€‚"
"""

        # C. å¼ºåˆ¶è°ƒæ•™å±‚ (Advanced Tuning Logic)
        tuning_instruction = ""
        
        if character.advanced_tuning.prevent_godmoding:
            tuning_instruction += """
ã€ç»å¯¹è§„åˆ™ã€‘ä½ åªèƒ½æå†™ {{char}} çš„åŠ¨ä½œå’Œè¯­è¨€ã€‚ä¸¥ç¦æå†™ {{user}} çš„ä»»ä½•åŠ¨ä½œã€å¿ƒç†ã€è¯­è¨€ã€‚ä½ çš„è¾“å‡ºå¿…é¡»åœ¨ {{char}} åšå®ŒåŠ¨ä½œåç«‹å³åœæ­¢ã€‚
""".replace("{{char}}", character.name).replace("{{user}}", "ç”¨æˆ·")

        if character.advanced_tuning.respect_user_agency:
            tuning_instruction += """
ã€å°Šé‡ç”¨æˆ·ä¸»æƒã€‘ä¸¥ç¦å¼ºåˆ¶å†³å®š {{user}} çš„è¡Œä¸ºç»“æœã€‚
é”™è¯¯ç¤ºèŒƒï¼šâ€œä»–æŠŠä½ æŒ‰åœ¨å¢™ä¸Šï¼Œä½ æ— æ³•åæŠ—ã€‚â€
æ­£ç¡®ç¤ºèŒƒï¼šâ€œä»–è¯•å›¾æŠŠä½ æŒ‰åœ¨å¢™ä¸Šï¼Œçœ¼ç¥å¸¦ç€å‹è¿«æ„Ÿã€‚â€
ä»»ä½•æ¶‰åŠèº«ä½“æ¥è§¦çš„è¡Œä¸ºï¼Œå¿…é¡»ç•™æœ‰ä½™åœ°ï¼Œç­‰å¾… {{user}} çš„ååº”ã€‚
""".replace("{{user}}", "ç”¨æˆ·")

        # Always Insert (è¯æ±‡å»é‡)
        tuning_instruction += """
ã€è¯æ±‡ç¦ä»¤ã€‘ç¦æ­¢è¿ç»­ä½¿ç”¨ä»¥ä¸‹é«˜é¢‘è¯ï¼šä¸ç”±å¾—ã€ä¸‹æ„è¯†åœ°ã€å˜´è§’å‹¾èµ·ã€çœ¼ç¥å¤æ‚ã€æ·±å¸ä¸€å£æ°”ã€‚è¯·ä½¿ç”¨æ›´å¤šæ ·çš„è¯æ±‡ã€‚
"""

        # D. ä¸Šä¸‹æ–‡ä¸èŒƒä¾‹å±‚ (Context & Anchor)
        context_layer = f"""
ã€ä¸–ç•Œè§‚ä¿¡æ¯ã€‘{world_context}

ã€ç³»ç»Ÿé”šç‚¹ã€‘ä¿æŒäººè®¾ã€‚ä½ ä¸æ˜¯AIåŠ©æ‰‹ã€‚
"""

        # ç»„åˆæœ€ç»ˆ System Prompt
        final_prompt = f"{core_instruction}\n{mode_instruction}\n{tuning_instruction}\n{context_layer}"
        return final_prompt.strip()

class ChatSystem:
    """
    æ ¸å¿ƒå¤§è„‘ï¼šè´Ÿè´£å¯¹è¯çš„æ ¸å¿ƒé€»è¾‘
    """
    def __init__(self, llm_client, world_system: WorldSystem):
        self.llm = llm_client
        self.world_system = world_system

    def chat(self, character: Character, user_input: str, history: List[ChatMessage], mode: str = "OFFLINE") -> str:
        """
        å¤„ç†ä¸€æ¬¡å¯¹è¯è¯·æ±‚
        """
        # 1. âœ… æ£€ç´¢ä¸–ç•Œè§‚ (æ”¯æŒå¤šä¸ªä¸–ç•Œä¹¦)
        world_context = self.world_system.get_world_context(
            user_input, 
            global_ids=character.linked_global_worlds,  # å…¨å±€ä¸–ç•Œä¹¦ ID åˆ—è¡¨
            local_ids=character.linked_local_worlds     # å±€éƒ¨ä¸–ç•Œä¹¦ ID åˆ—è¡¨
        )

        # 2. æ„å»º System Prompt
        system_prompt = PromptBuilder.build(character, world_context, history, mode)

        # 3. å‡†å¤‡æ¶ˆæ¯åˆ—è¡¨ (History + User Input)
        # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æŠŠ ChatMessage å¯¹è±¡è½¬æ¢ä¸º LLM å®¢æˆ·ç«¯éœ€è¦çš„å­—å…¸æ ¼å¼
        messages_payload = [{"role": msg.role, "content": msg.content} for msg in history]
        messages_payload.append({"role": "user", "content": user_input})

        # 4. è°ƒç”¨ LLM
        response_text = self.llm.generate_text(system_prompt, messages_payload)
        
        return response_text
